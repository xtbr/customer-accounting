<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∞—Å—á–µ—Ç–Ω–∏–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–ª–∏–≥—Ä–∞—Ñ–∏–∏</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center px-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üñ®Ô∏è –ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è Tez print</h1>
        <p class="text-gray-600">–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
      </div>

      <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
      <div id="loginForm">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <form id="loginFormElement" class="space-y-4">
          <input type="email" id="loginUsername" required placeholder="Email"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <input type="password" id="loginPassword" required placeholder="–ü–∞—Ä–æ–ª—å"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <button type="submit"
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
            –í–æ–π—Ç–∏
          </button>
        </form>
        <p class="text-center mt-4 text-sm text-gray-600">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
          <button id="showRegister" class="text-blue-600 hover:text-blue-700 font-medium">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </p>
      </div>

      <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
      <div id="registerForm" class="hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <form id="registerFormElement" class="space-y-4">
          <input type="text" id="registerName" required placeholder="–ò–º—è"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <input type="email" id="registerUsername" required placeholder="Email"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <input type="password" id="registerPassword" required placeholder="–ü–∞—Ä–æ–ª—å"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <button type="submit"
                  class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          </button>
        </form>
        <p class="text-center mt-4 text-sm text-gray-600">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
          <button id="showLogin" class="text-blue-600 hover:text-blue-700 font-medium">–í–æ–π—Ç–∏</button>
        </p>
      </div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <div id="mainApp" class="hidden">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≤—ã—Ö–æ–¥–æ–º -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-4xl font-bold text-gray-800 mb-2">üìä –†–∞—Å—á–µ—Ç–Ω–∏–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>
          <p class="text-gray-600">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName"></span>!</p>
        </div>
        <button id="logoutBtn" 
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          üö™ –í—ã–π—Ç–∏
        </button>
      </div>

      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center space-x-4">
            <h3 class="text-lg font-semibold text-gray-800">üìÖ –ü–µ—Ä–∏–æ–¥:</h3>
            <select id="periodSelect" 
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
              <option value="custom-day">–í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å</option>
              <option value="custom-month">–í—ã–±—Ä–∞—Ç—å –º–µ—Å—è—Ü</option>
            </select>
            <input type="date" id="customDate" class="hidden px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <input type="month" id="customMonth" class="hidden px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="text-sm text-gray-600" id="currentPeriod"></div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
          <div class="flex items-center">
            <div class="text-3xl mr-4">üë•</div>
            <div>
              <p class="text-sm text-gray-600">–ö–ª–∏–µ–Ω—Ç–æ–≤</p>
              <p class="text-2xl font-bold text-gray-800" id="totalClients">0</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
          <div class="flex items-center">
            <div class="text-3xl mr-4">üí∞</div>
            <div>
              <p class="text-sm text-gray-600">–í—ã—Ä—É—á–∫–∞</p>
              <p class="text-2xl font-bold text-gray-800" id="totalRevenue">0 ‚ÇΩ</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
          <div class="flex items-center">
            <div class="text-3xl mr-4">üìà</div>
            <div>
              <p class="text-sm text-gray-600">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</p>
              <p class="text-2xl font-bold text-gray-800" id="averageCheck">0 ‚ÇΩ</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
          <div class="flex items-center">
            <div class="text-3xl mr-4">üèÜ</div>
            <div>
              <p class="text-sm text-gray-600">–õ—É—á—à–∏–π –¥–µ–Ω—å</p>
              <p class="text-lg font-bold text-gray-800" id="bestDay">-</p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
            <span class="text-2xl mr-3">‚ûï</span>
            –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
          </h2>
          
          <form id="clientForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
              <input type="text" id="clientName" required 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–£—Å–ª—É–≥–∞</label>
              <select id="serviceType" required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
                <option value="–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫">–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫</option>
                <option value="–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫">–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫</option>
                <option value="–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤">–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤</option>
                <option value="–ü–µ—á–∞—Ç—å –±—É–∫–ª–µ—Ç–æ–≤">–ü–µ—á–∞—Ç—å –±—É–∫–ª–µ—Ç–æ–≤</option>
                <option value="–ü–µ—á–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π">–ü–µ—á–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</option>
                <option value="–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤">–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</option>
                <option value="–û—Ç–∫—Ä—ã–≤–∞–Ω–∏–µ —Ç—É–Ω–¥—É–∫–∞">–û—Ç–∫—Ä—ã–≤–∞–Ω–∏–µ —Ç—É–Ω–¥—É–∫–∞</option>
                <option value="–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                <option value="–ü–µ—Ä–µ–ø–ª–µ—Ç">–ü–µ—Ä–µ–ø–ª–µ—Ç</option>
                <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (‚ÇΩ)</label>
              <input type="number" id="paymentAmount" required min="0" step="0.01"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                     placeholder="0.00">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞</label>
              <input type="date" id="paymentDate" required
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
            </div>
            
            <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
              <span class="mr-2">üíæ</span>
              –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
            </button>
          </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
              <span class="text-2xl mr-3">üìã</span>
              –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
            </h2>
            <div class="flex space-x-2">
              <button id="exportData" 
                      class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                üìä –≠–∫—Å–ø–æ—Ä—Ç
              </button>
              <button id="clearPeriod" 
                      class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
              </button>
            </div>
          </div>
          
          <div id="clientsList" class="space-y-3 max-h-96 overflow-y-auto">
            <div class="text-center text-gray-500 py-8">
              <div class="text-4xl mb-2">üìù</div>
              <p>–ö–ª–∏–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</p>
            </div>
          </div>
        </div>
      </div>

      <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
      <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <span class="text-xl mr-3">üîç</span>
          –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
            <input type="text" id="searchName" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø–æ–∏—Å–∫–∞">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">–§–∏–ª—å—Ç—Ä –ø–æ —É—Å–ª—É–≥–µ</label>
            <select id="filterService" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
              <option value="–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫">–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫</option>
              <option value="–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫">–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫</option>
              <option value="–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤">–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤</option>
              <option value="–ü–µ—á–∞—Ç—å –±—É–∫–ª–µ—Ç–æ–≤">–ü–µ—á–∞—Ç—å –±—É–∫–ª–µ—Ç–æ–≤</option>
              <option value="–ü–µ—á–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π">–ü–µ—á–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</option>
              <option value="–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤">–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</option>
              <option value="–û—Ç–∫—Ä—ã–≤–∞–Ω–∏–µ —Ç—É–Ω–¥—É–∫–∞">–û—Ç–∫—Ä—ã–≤–∞–Ω–∏–µ —Ç—É–Ω–¥—É–∫–∞</option>
              <option value="–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
              <option value="–ü–µ—Ä–µ–ø–ª–µ—Ç">–ü–µ—Ä–µ–ø–ª–µ—Ç</option>
              <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="sortBy" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="date-desc">–ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)</option>
              <option value="date-asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–µ)</option>
              <option value="amount-desc">–ü–æ —Å—É–º–º–µ (–±–æ–ª—å—à–µ –ø–µ—Ä–≤—ã–µ)</option>
              <option value="amount-asc">–ü–æ —Å—É–º–º–µ (–º–µ–Ω—å—à–µ –ø–µ—Ä–≤—ã–µ)</option>
              <option value="name-asc">–ü–æ –∏–º–µ–Ω–∏ (–ê-–Ø)</option>
              <option value="name-desc">–ü–æ –∏–º–µ–Ω–∏ (–Ø-–ê)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º (–¥–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) -->
      <div id="dailyStats" class="bg-white rounded-xl shadow-lg p-6 mt-8 hidden">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <span class="text-xl mr-3">üìä</span>
          –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
        </h3>
        <div id="dailyStatsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // üîπ Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAE-_HVfjMI5pQ8udhBsw_uBiCA45I15RE",
      authDomain: "polygraphy-clients.firebaseapp.com",
      projectId: "polygraphy-clients",
      storageBucket: "polygraphy-clients.appspot.com",
      messagingSenderId: "31878834170",
      appId: "1:31878834170:web:d39b6725356ec5e1ba6643",
      measurementId: "G-3Z24QJP99H"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let clients = [];
    let filteredClients = [];

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
    window.deleteClient = async function(id) {
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?")) {
        await db.collection("clients").doc(id).delete();
        loadClients();
      }
    };

    // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
    document.getElementById("registerFormElement").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("registerName").value;
      const email = document.getElementById("registerUsername").value;
      const password = document.getElementById("registerPassword").value;
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection("users").doc(userCredential.user.uid).set({ name, email });
        currentUser = { id: userCredential.user.uid, name };
        showMainApp();
      } catch (err) { 
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", err);
        alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + err.message); 
      }
    });

    document.getElementById("loginFormElement").addEventListener("submit", async e => {
      e.preventDefault();
      const email = document.getElementById("loginUsername").value;
      const password = document.getElementById("loginPassword").value;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const docSnap = await db.collection("users").doc(userCredential.user.uid).get();
        if (docSnap.exists) {
          currentUser = { id: userCredential.user.uid, ...docSnap.data() };
          showMainApp();
        } else {
          throw new Error("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        }
      } catch (err) { 
        console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", err);
        alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message); 
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await auth.signOut();
        currentUser = null;
        showAuthScreen();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", err);
      }
    });

    // --- –ö–ª–∏–µ–Ω—Ç—ã ---
    async function loadClients() {
      try {
        const snapshot = await db.collection("clients")
          .where("userId", "==", currentUser.id)
          .get();
        clients = snapshot.docs.map(doc => ({ 
          id: doc.id, 
          ...doc.data(),
          date: doc.data().date || new Date().toISOString().split('T')[0]
        }));
        applyFilters();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:", err);
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤");
      }
    }

    async function saveClient(client) {
      try {
        await db.collection("clients").add({
          ...client,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadClients();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:", err);
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞");
      }
    }

    function displayClients() {
      const list = document.getElementById("clientsList");
      
      if (filteredClients.length === 0) {
        list.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <div class="text-4xl mb-2">üìù</div>
            <p>–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = filteredClients.map(c => `
        <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center hover:bg-gray-100 transition-colors">
          <div>
            <b>${c.name}</b> ‚Äî ${c.service} ‚Äî ${c.amount.toFixed(2)} ‚ÇΩ (${formatDate(c.date)})
          </div>
          <button onclick="deleteClient('${c.id}')" class="text-red-500 hover:text-red-700 transition-colors">üóëÔ∏è</button>
        </div>
      `).join("");
      
      updateStatistics();
    }

    function formatDate(dateString) {
      if (!dateString) return "–Ω–µ—Ç –¥–∞—Ç—ã";
      const date = new Date(dateString);
      return date.toLocaleDateString('ru-RU');
    }

    function updateStatistics() {
      const totalClients = filteredClients.length;
      const totalRevenue = filteredClients.reduce((sum, c) => sum + c.amount, 0);
      const averageCheck = totalClients > 0 ? totalRevenue / totalClients : 0;
      
      document.getElementById("totalClients").textContent = totalClients;
      document.getElementById("totalRevenue").textContent = totalRevenue.toFixed(2) + " ‚ÇΩ";
      document.getElementById("averageCheck").textContent = averageCheck.toFixed(2) + " ‚ÇΩ";
      
      // –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à–∏–π –¥–µ–Ω—å
      if (filteredClients.length > 0) {
        const daysRevenue = {};
        filteredClients.forEach(c => {
          daysRevenue[c.date] = (daysRevenue[c.date] || 0) + c.amount;
        });
        
        const bestDay = Object.entries(daysRevenue).reduce((best, [date, revenue]) => 
          revenue > best.revenue ? { date, revenue } : best, { date: "", revenue: 0 });
        
        document.getElementById("bestDay").textContent = `${formatDate(bestDay.date)} (${bestDay.revenue.toFixed(2)} ‚ÇΩ)`;
      } else {
        document.getElementById("bestDay").textContent = "-";
      }
    }

    function applyFilters() {
      const nameSearch = document.getElementById("searchName").value.toLowerCase();
      const serviceFilter = document.getElementById("filterService").value;
      const sortBy = document.getElementById("sortBy").value;
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
      filteredClients = clients.filter(c => {
        const nameMatch = c.name.toLowerCase().includes(nameSearch);
        const serviceMatch = !serviceFilter || c.service === serviceFilter;
        return nameMatch && serviceMatch;
      });
      
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      filteredClients.sort((a, b) => {
        switch (sortBy) {
          case "date-desc": return new Date(b.date) - new Date(a.date);
          case "date-asc": return new Date(a.date) - new Date(b.date);
          case "amount-desc": return b.amount - a.amount;
          case "amount-asc": return a.amount - b.amount;
          case "name-asc": return a.name.localeCompare(b.name);
          case "name-desc": return b.name.localeCompare(a.name);
          default: return 0;
        }
      });
      
      displayClients();
    }

    // --- UI ---
    function showAuthScreen() {
      document.getElementById("authScreen").classList.remove("hidden");
      document.getElementById("mainApp").classList.add("hidden");
    }

    function showMainApp() {
      document.getElementById("authScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      document.getElementById("userName").textContent = currentUser.name;
      
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("paymentDate").value = today;
      
      loadClients();
    }

    // --- –§–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ ---
    document.getElementById("clientForm").addEventListener("submit", e => {
      e.preventDefault();
      const client = {
        name: document.getElementById("clientName").value,
        service: document.getElementById("serviceType").value,
        amount: parseFloat(document.getElementById("paymentAmount").value),
        date: document.getElementById("paymentDate").value,
        userId: currentUser.id
      };
      saveClient(client);
      e.target.reset();
    });

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º ---
    document.getElementById("showRegister").onclick = () => {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("registerForm").classList.remove("hidden");
    };
    document.getElementById("showLogin").onclick = () => {
      document.getElementById("registerForm").classList.add("hidden");
      document.getElementById("loginForm").classList.remove("hidden");
    };

    // --- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ---
    document.getElementById("searchName").addEventListener("input", applyFilters);
    document.getElementById("filterService").addEventListener("change", applyFilters);
    document.getElementById("sortBy").addEventListener("change", applyFilters);

    // --- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö ---
    document.getElementById("exportData").addEventListener("click", () => {
      if (filteredClients.length === 0) {
        alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
        return;
      }
      
      let csv = "–ò–º—è,–£—Å–ª—É–≥–∞,–°—É–º–º–∞,–î–∞—Ç–∞\n";
      filteredClients.forEach(c => {
        csv += `"${c.name}","${c.service}",${c.amount},"${c.date}"\n`;
      });
      
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `clients_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
    });

    // --- –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥ ---
    document.getElementById("clearPeriod").addEventListener("click", async () => {
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥?")) {
        try {
          const batch = db.batch();
          filteredClients.forEach(c => {
            const ref = db.collection("clients").doc(c.id);
            batch.delete(ref);
          });
          await batch.commit();
          loadClients();
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö");
        }
      }
    });

    // --- –ü–µ—Ä–∏–æ–¥—ã ---
    document.getElementById("periodSelect").addEventListener("change", function() {
      document.getElementById("customDate").classList.add("hidden");
      document.getElementById("customMonth").classList.add("hidden");
      
      if (this.value === "custom-day") {
        document.getElementById("customDate").classList.remove("hidden");
      } else if (this.value === "custom-month") {
        document.getElementById("customMonth").classList.remove("hidden");
      }
      
      applyFilters();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    auth.onAuthStateChanged(user => {
      if (user) {
        db.collection("users").doc(user.uid).get()
          .then(doc => {
            if (doc.exists) {
              currentUser = { id: user.uid, ...doc.data() };
              showMainApp();
            } else {
              console.error("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
              auth.signOut();
            }
          })
          .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
          });
      } else {
        showAuthScreen();
      }
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("paymentDate").value = today;
    });
  </script>
</body>
</html>